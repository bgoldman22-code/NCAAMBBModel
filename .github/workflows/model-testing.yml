name: Model Testing and Validation

on:
  push:
    branches: [ main ]
    paths:
      - 'ml/**'
      - 'scripts/**'
      - 'data-collection/**'
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pandas numpy scikit-learn joblib pytest
        
    - name: Run unit tests
      run: |
        python -m pytest ml/experiments_ncaabb/test_odds_aware_filtering.py -v || echo "Tests not found"
        python -m pytest ml/experiments_ncaabb/test_longdog_filtering.py -v || echo "Tests not found"
        
    - name: Test model loading
      run: |
        python -c "from ml.ncaabb_variant_b_model import load_variant_b_model; model, meta = load_variant_b_model(); print(f'Model loaded: {meta}')"
        
    - name: Validate model files
      run: |
        echo "Checking for required model files..."
        test -f "models/variant_b_production/variant_b_model.pkl" && echo "✅ Model file exists" || echo "⚠️ Model file missing"
        test -f "models/variant_b_production/variant_b_metadata.json" && echo "✅ Metadata file exists" || echo "⚠️ Metadata file missing"
        test -f "models/variant_b_production/variant_b_feature_cols.json" && echo "✅ Feature cols file exists" || echo "⚠️ Feature cols file missing"
